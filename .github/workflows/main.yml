name: Deployment

concurrency:
  group: deploy-production
  cancel-in-progress: true

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –ù—É–∂–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps and build frontend
        run: |
          npm ci
          npm run build

      - name: "–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—ã"
        run: |
          echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_ALERT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}" >> .env
          echo "API_DOMAIN=https://abxtest.com/" >> .env
          echo "ENVIRONMENT=Production" >> .env

      - name: Check what changed
        id: changes
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # –ü–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç - —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Å—ë –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            CHANGED_FILES=$(git diff --name-only --diff-filter=A HEAD)
          fi
          
          if echo "$CHANGED_FILES" | grep -qE "(docker/php/Dockerfile|docker/php/)"; then
            echo "php_dockerfile_changed=true" >> $GITHUB_OUTPUT
          else
            echo "php_dockerfile_changed=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -qE "(composer\.json|composer\.lock)"; then
            echo "composer_changed=true" >> $GITHUB_OUTPUT
          else
            echo "composer_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install rsync client
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rsync sshpass

      - name: Rsync only required files (fast, incremental)
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          PORT: ${{ secrets.PORT }}
        run: |
          RSYNC_EXCLUDES=(
            "--exclude=.git/"
            "--exclude=node_modules/"
            "--exclude=.github/"
            "--exclude=frontend/"
            "--exclude=package*.json"
            "--exclude=webpack.config.js"
            "--exclude=Makefile"
            "--exclude=README.md"
          )
          sshpass -p "$PASSWORD" rsync -az --delete -e "ssh -o StrictHostKeyChecking=no -p $PORT" \
            "${RSYNC_EXCLUDES[@]}" \
            ./docker-compose.yml ./docker ./backend ./dist ./.env \
            "$USERNAME@$HOST:/var/www/abxtest.com/"

      - name: Smart deploy (build/composer only if needed)
        uses: appleboy/ssh-action@master
        env:
          PHP_DOCKERFILE_CHANGED: ${{ steps.changes.outputs.php_dockerfile_changed }}
          COMPOSER_CHANGED: ${{ steps.changes.outputs.composer_changed }}
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            export COMPOSE_DOCKER_CLI_BUILD=1
            export DOCKER_BUILDKIT=1
            cd /var/www/abxtest.com
            
            # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º PHP –æ–±—Ä–∞–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è Dockerfile
            if [ "$PHP_DOCKERFILE_CHANGED" = "true" ]; then
              echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º PHP –æ–±—Ä–∞–∑ (–∏–∑–º–µ–Ω–∏–ª—Å—è Dockerfile)..."
              docker compose build abx-php
            else
              echo "‚è≠Ô∏è  PHP –æ–±—Ä–∞–∑ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É"
            fi
            
            # –ü–æ–¥–Ω–∏–º–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã (docker compose —Å–∞–º —Ä–µ—à–∏—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å)
            docker compose up -d abx-nginx abx-php
            
            # Composer install —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if [ "$COMPOSER_CHANGED" = "true" ]; then
              echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Composer..."
              docker compose exec -T abx-php bash -c "composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader"
            else
              echo "‚è≠Ô∏è  –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º composer install"
            fi
            
            docker compose ps

      - name: Smoke test
        uses: wei/curl@v1
        with:
          args: https://abxtest.com/

      - name: Get commit message
        if: ${{ github.event_name == 'push' }}
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send telegram message on push
        if: ${{ github.event_name == 'push' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ github.actor }} —Å–æ–∑–¥–∞–ª commit:
            Commit: ${{ steps.commit.outputs.message }}

            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}

            –ò–∑–º–µ–Ω–µ–Ω–∏—è: https://github.com/${{ github.repository }}/commit/${{github.sha}}