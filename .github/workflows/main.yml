name: Deployment

concurrency:
  group: deploy-production
  cancel-in-progress: true

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps and build frontend
        run: |
          npm ci
          npm run build

      - name: "Заполнение переменных среды"
        run: |
          echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_ALERT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}" >> .env
          echo "API_DOMAIN=https://abxtest.com/" >> .env
          echo "ENVIRONMENT=Production" >> .env

      - name: Install rsync client
        run: |
          sudo apt-get update -y
          sudo apt-get install -y rsync sshpass

      - name: Rsync only required files (fast, incremental)
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          PORT: ${{ secrets.PORT }}
        run: |
          RSYNC_EXCLUDES=(
            "--exclude=.git/"
            "--exclude=node_modules/"
            "--exclude=.github/"
            "--exclude=frontend/"
          )
          sshpass -p "$PASSWORD" rsync -az --delete -e "ssh -o StrictHostKeyChecking=no -p $PORT" \
            "${RSYNC_EXCLUDES[@]}" \
            ./docker-compose.yml ./docker ./backend ./dist ./.env \
            "$USERNAME@$HOST:/var/www/abxtest.com/"

      - name: Restart services (no build/pull, just up)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e
            cd /var/www/abxtest.com
            docker compose up -d abx-nginx abx-php
            docker compose ps

      - name: Smoke test
        uses: wei/curl@v1
        with:
          args: https://abxtest.com/

      - name: Send telegram message on push
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ github.actor }} создал commit:
            Commit: ${{ github.event.commits[0].message }}

            Репозиторий: ${{ github.repository }}

            Изменения: https://github.com/${{ github.repository }}/commit/${{github.sha}}